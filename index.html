<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Nutritionist</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* --------------------------------------------------
       THEME TOKENS (light, dark, dim)
       -------------------------------------------------- */
    :root {
      --bg: #0b0b0c;
      --card: #121316;
      --card-2: #121316;
      --fg: #e7e7ea;
      --muted: #a1a1ac;
      --border: #24262b;
      --accent: #22c55e;
      --accent-2: #10b981;
      --chip: #1e1f24;
      --bubble-user: rgba(34,197,94,.10);
      --bubble-user-border: rgba(34,197,94,.35);
      --bubble-ai: rgba(255,255,255,.06);
    }
    [data-theme="system"] { color-scheme: light dark; }
    @media (prefers-color-scheme: light) {
      [data-theme="system"] {
        --bg:#f6f7f8; --card:#ffffff; --card-2:#ffffff; --fg:#0f1115; --muted:#5b5e66;
        --border:#e7e8ea; --accent:#16a34a; --accent-2:#22c55e; --chip:#f0f1f3;
        --bubble-user: rgba(22,163,74,.10); --bubble-user-border: rgba(22,163,74,.35); --bubble-ai:#f5f7fa;
      }
    }
    [data-theme="light"] {
      --bg:#f6f7f8; --card:#ffffff; --card-2:#ffffff; --fg:#0f1115; --muted:#5b5e66;
      --border:#e7e8ea; --accent:#16a34a; --accent-2:#22c55e; --chip:#f0f1f3;
      --bubble-user: rgba(22,163,74,.10); --bubble-user-border: rgba(22,163,74,.35); --bubble-ai:#f5f7fa;
    }
    [data-theme="dark"] {
      --bg:#0b0b0c; --card:#121316; --card-2:#121316; --fg:#e7e7ea; --muted:#a1a1ac;
      --border:#24262b; --accent:#22c55e; --accent-2:#10b981; --chip:#1e1f24;
      --bubble-user: rgba(34,197,94,.10); --bubble-user-border: rgba(34,197,94,.35); --bubble-ai:rgba(255,255,255,.06);
    }
    [data-theme="dim"] {
      --bg:#111214; --card:#17181b; --card-2:#1b1c20; --fg:#e5e7eb; --muted:#adb1bb;
      --border:#2a2c33; --accent:#7dd3fc; --accent-2:#60a5fa; --chip:#1f2126;
      --bubble-user: rgba(125,211,252,.10); --bubble-user-border: rgba(125,211,252,.35); --bubble-ai:rgba(255,255,255,.05);
    }

    /* --------------------------------------------------
       PRIMITIVES / COMPONENTS
       -------------------------------------------------- */
    html, body { height: 100%; }
    body { background: var(--bg); color: var(--fg); font-feature-settings: "ss01","cv02"; }

    .container-outer { max-width: 1200px; margin-inline: auto; padding-inline: 1rem; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; }
    .card-header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
    .card-body { padding: 16px; }
    .card-footer { padding: 12px 16px; border-top: 1px solid var(--border); }

    .chip { background: var(--chip); border: 1px solid var(--border); color: var(--muted); padding: 2px 8px; border-radius: 999px; font-size: 12px; }

    .btn { border-radius: 12px; padding: 10px 12px; font-size: 14px; line-height: 1; display: inline-flex; gap: 8px; align-items:center; justify-content:center; }
    .btn-primary { background: var(--accent); color: #001007; }
    .btn-primary:hover { filter: brightness(1.05); }
    .btn-secondary { background: var(--card-2); border: 1px solid var(--border); }
    .btn-ghost { background: transparent; border: 1px solid var(--border); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .input, .select, .textarea {
      width: 100%; background: var(--card-2); color: var(--fg); border: 1px solid var(--border);
      border-radius: 12px; padding: 9px 10px; font-size: 14px; outline: none;
    }
    .textarea { min-height: 112px; resize: vertical; }

    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display:inline-block; }

    .bubble-user {
      background: var(--bubble-user); border: 1px solid var(--bubble-user-border);
      border-radius: 14px; padding: 10px 12px; max-width: 85%;
    }
    .bubble-ai {
      background: var(--bubble-ai); border: 1px solid var(--border);
      border-radius: 14px; padding: 10px 12px; max-width: 85%;
    }

    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: var(--chip); border: 1px solid var(--border); border-radius: 6px; padding: 2px 6px; font-size: 12px; color: var(--muted); }

    /* Focus ring */
    .input:focus, .select:focus, .textarea:focus, .btn:focus, select:focus, button:focus { outline: 2px solid var(--accent-2); outline-offset: 2px; }

    /* Range track/tick (simple) */
    input[type="range"] { accent-color: var(--accent); width: 100%; }

    /* Dialog */
    dialog { background: var(--card); color: var(--fg); border: 1px solid var(--border); border-radius: 16px; width: 540px; max-width: 95vw; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="sticky top-0 z-30 border-b" style="border-color: var(--border); backdrop-filter: blur(4px); background: color-mix(in oklab, var(--bg) 85%, transparent);">
    <div class="container-outer py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="grid place-items-center h-10 w-10 rounded-xl" style="background: linear-gradient(135deg,var(--accent),var(--accent-2));">
          <i data-lucide="brain" class="h-5 w-5 text-black/80"></i>
        </div>
        <div>
          <div class="text-lg font-semibold tracking-tight">AI Nutritionist</div>
          <div class="text-xs" style="color: var(--muted)">Personalized plans. Real-time coaching.</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="chip">Beta</span>
        <select id="themeSelect" class="select w-[160px]">
          <option value="system">System</option>
          <option value="dark" selected>Dark</option>
          <option value="dim">Dim / Gray</option>
          <option value="light">Light</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container-outer py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- Sidebar -->
    <aside class="lg:col-span-3 space-y-6">
      <section class="card">
        <div class="card-header flex items-center gap-2">
          <i data-lucide="settings" class="h-4 w-4"></i>
          <h2 class="text-sm font-semibold">Profile & Goals</h2>
        </div>
        <div class="card-body space-y-4">
          <div class="row">
            <div>
              <label class="label">Age</label>
              <input id="age" type="number" class="input" value="23"/>
            </div>
            <div>
              <label class="label">Sex</label>
              <select id="sex" class="select">
                <option value="male" selected>Male</option>
                <option value="female">Female</option>
              </select>
            </div>
            <div>
              <label class="label">Height (cm)</label>
              <input id="height" type="number" class="input" value="170"/>
            </div>
            <div>
              <label class="label">Weight (kg)</label>
              <input id="weight" type="number" class="input" value="79.4"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label class="label">Activity</label>
              <select id="activity" class="select">
                <option value="sedentary">Sedentary</option>
                <option value="light">Light</option>
                <option value="moderate" selected>Moderate</option>
                <option value="active">Active</option>
              </select>
            </div>
            <div>
              <label class="label">Goal</label>
              <select id="goal" class="select">
                <option value="fatloss">Fat loss</option>
                <option value="recomp" selected>Recomp</option>
                <option value="muscle">Muscle gain</option>
              </select>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between text-sm"><span>Protein (g)</span><span id="pOut" class="font-medium tabular-nums">180</span></div>
            <input id="pRange" type="range" min="80" max="260" step="5" value="180" />

            <div class="flex items-center justify-between text-sm"><span>Fat (g)</span><span id="fOut" class="font-medium tabular-nums">80</span></div>
            <input id="fRange" type="range" min="30" max="140" step="5" value="80" />

            <div class="flex items-center justify-between text-sm"><span>Carbs (g)</span><span id="cOut" class="font-medium tabular-nums">255</span></div>
            <input id="cRange" type="range" min="80" max="420" step="5" value="255" />

            <div class="text-xs" style="color: var(--muted)">~<span id="kcalOut">2450</span> kcal/day</div>
          </div>
        </div>
        <div class="card-footer flex gap-2">
          <button id="btnGeneratePlan" class="btn btn-primary w-full"><i data-lucide="sparkles" class="h-4 w-4"></i>Generate Plan</button>
          <button id="btnPrefs" class="btn btn-secondary w-full"><i data-lucide="sliders" class="h-4 w-4"></i>Preferences</button>
        </div>
      </section>

      <section class="card">
        <div class="card-header flex items-center gap-2">
          <i data-lucide="activity" class="h-4 w-4"></i>
          <h2 class="text-sm font-semibold">Progress</h2>
        </div>
        <div class="card-body space-y-4">
          <canvas id="weightChart" height="150"></canvas>
          <canvas id="calChart" height="150"></canvas>
        </div>
      </section>
    </aside>

    <!-- Center -->
    <section class="lg:col-span-5 space-y-6">
      <section class="card">
        <div class="card-header">
          <div class="flex items-center gap-2">
            <i data-lucide="salad" class="h-4 w-4"></i>
            <h2 class="text-sm font-semibold">Today’s Plan</h2>
          </div>
          <p class="mt-1 text-xs" style="color: var(--muted)">Auto-generated meals, adjustable to your macros.</p>
        </div>
        <div id="mealsGrid" class="card-body grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        <div class="card-footer flex flex-wrap gap-2">
          <button id="btnAnalyzeMeal" class="btn btn-secondary"><i data-lucide="apple" class="h-4 w-4"></i>Analyze Meal</button>
          <button class="btn btn-ghost"><i data-lucide="dumbbell" class="h-4 w-4"></i>Post-Workout Snack</button>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2 class="text-sm font-semibold">Recipe Builder</h2>
          <p class="mt-1 text-xs" style="color: var(--muted)">Paste ingredients; get macros and cleaner swaps.</p>
        </div>
        <div class="card-body space-y-3">
          <textarea id="recipeInput" class="textarea" placeholder="e.g., 7oz sirloin, 200g cooked rice, 1 tbsp olive oil, broccoli"></textarea>
          <div class="flex flex-wrap gap-2">
            <button id="btnEstimate" class="btn btn-primary">Estimate Macros</button>
            <button id="btnSuggest" class="btn btn-secondary">Suggest Swaps</button>
          </div>
        </div>
      </section>
    </section>

    <!-- Chat -->
    <section class="lg:col-span-4 space-y-6">
      <section class="card h-[560px] flex flex-col">
        <div class="card-header">
          <div class="flex items-center gap-2">
            <i data-lucide="sparkles" class="h-4 w-4"></i>
            <h2 class="text-sm font-semibold">Coach</h2>
          </div>
          <p class="mt-1 text-xs" style="color: var(--muted)">Ask anything. Get precise, actionable answers.</p>
        </div>
        <div id="chatScroll" class="card-body flex-1 overflow-y-auto space-y-3 pr-1"></div>
        <div class="card-footer">
          <div class="flex w-full items-center gap-2">
            <input id="chatInput" class="input" placeholder="Ask your coach…"/>
            <button id="btnSend" class="btn btn-primary"><i data-lucide="send" class="h-4 w-4"></i></button>
          </div>
          <div class="mt-2 text-[11px]" style="color: var(--muted)">Tip: Press <span class="kbd">Enter</span> to send, <span class="kbd">Shift</span>+<span class="kbd">Enter</span> for a new line.</div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <h2 class="text-sm font-semibold">Quick Actions</h2>
          <p class="mt-1 text-xs" style="color: var(--muted)">Common tasks.</p>
        </div>
        <div class="card-body grid gap-2">
          <button id="qaGenerate" class="btn btn-primary w-full"><i data-lucide="sparkles" class="h-4 w-4"></i>Generate Today</button>
          <button id="qaAnalyze" class="btn btn-secondary w-full"><i data-lucide="apple" class="h-4 w-4"></i>Analyze Meal</button>
          <button id="qaBuildWeek" class="btn btn-secondary w-full"><i data-lucide="salad" class="h-4 w-4"></i>Build 7-Day Plan</button>
        </div>
      </section>
    </section>
  </main>

  <!-- Footer -->
  <footer class="border-t py-6" style="border-color: var(--border);">
    <div class="container-outer text-xs flex items-center justify-between" style="color: var(--muted)">
      <span>© <span id="year"></span> AI Nutritionist</span>
      <span>Backend: ai-nutritionist-zu5b.onrender.com</span>
    </div>
  </footer>

  <!-- Preferences Modal -->
  <dialog id="prefsDialog">
    <div class="card-header">
      <h3 class="text-sm font-semibold">Dietary Preferences</h3>
    </div>
    <div class="card-body space-y-3">
      <label class="label">Foods you avoid or want more of</label>
      <textarea id="prefsText" class="textarea" placeholder="e.g., avoid dairy, prefer red meat, quick meals"></textarea>
      <div class="flex justify-end gap-2 pt-2">
        <button id="prefsClose" class="btn btn-secondary">Close</button>
        <button id="prefsSave" class="btn btn-primary">Save</button>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- THEME ----------
    const themeSelect = document.getElementById("themeSelect");
    const savedTheme = localStorage.getItem("ai_nutritionist_theme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeSelect.value = savedTheme;
    themeSelect.addEventListener("change", (e) => {
      const v = e.target.value;
      document.documentElement.setAttribute("data-theme", v);
      localStorage.setItem("ai_nutritionist_theme", v);
      rebuildCharts(); // recolor charts when theme swaps
    });

    // ---------- API CONFIG ----------
    const API_BASE = "https://ai-nutritionist-zu5b.onrender.com"; // Render backend
    let AUTH_TOKEN = null; // NEW: Bearer token fallback for iOS/Safari

    async function apiFetch(path, payload) {
      const headers = { "Content-Type": "application/json" };
      if (AUTH_TOKEN) headers["Authorization"] = "Bearer " + AUTH_TOKEN; // add token if present
      const r = await fetch(API_BASE + path, {
        method: "POST",
        credentials: "include",               // try cookie path if allowed
        headers,
        body: JSON.stringify(payload || {})
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function ensureLogin() {
      try {
        const pwd = prompt("Enter site password");
        if (!pwd) throw new Error("No password");
        const r = await fetch(API_BASE + "/login", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pwd })
        });
        if (!r.ok) throw new Error("Login failed");
        // read token for browsers that block cross-site cookies
        const data = await r.json().catch(() => ({}));
        if (data && data.token) AUTH_TOKEN = data.token;
      } catch (e) {
        alert("Login error. Refresh to try again.");
        throw e;
      }
    }

    // ---------- STATE ----------
    const macroBias = { protein: 180, fat: 80, carbs: 255 };
    const starterMeals = [
      { id: 1, title: "High-Protein Breakfast Bowl", kcal: 520, macros: { P:45, C:55, F:15 }, items: ["4 eggs (2 whole, 2 whites)","Oats 60g","Blueberries","Almonds"] },
      { id: 2, title: "Simple Steak & Rice", kcal: 680, macros: { P:55, C:65, F:20 }, items: ["Sirloin 7oz","Jasmine rice 200g cooked","Broccoli","Olive oil"] },
      { id: 3, title: "Greek Yogurt Parfait", kcal: 380, macros: { P:30, C:40, F:10 }, items: ["Greek yogurt 250g","Honey 1 tsp","Granola 30g","Strawberries"] },
    ];
    let meals = [...starterMeals];
    const messages = [{ role: "assistant", content: "Hi! Tell me your goal and foods you like/dislike." }];

    // ---------- UTIL ----------
    const $ = (id) => document.getElementById(id);
    const esc = (s) => (s || "").replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));
    const kcalFromMacros = ({ protein, fat, carbs }) => protein*4 + fat*9 + carbs*4;

    function setLoading(is) {
      ["btnSend","btnGeneratePlan","qaGenerate","qaAnalyze","qaBuildWeek","btnAnalyzeMeal","btnEstimate","btnSuggest"]
        .forEach(id => { const el = $(id); if (el) el.disabled = is; });
    }

    // ---------- RENDER ----------
    function renderMeals() {
      const grid = $("mealsGrid");
      grid.innerHTML = "";
      meals.forEach(m => {
        const el = document.createElement("section");
        el.className = "card";
        el.innerHTML = `
          <div class="card-header pb-2">
            <div class="flex items-center justify-between">
              <div class="text-base font-semibold">${esc(m.title)}</div>
              <span class="chip">${m.kcal} kcal</span>
            </div>
            <div class="mt-1 text-xs" style="color: var(--muted)">P${m.macros.P} · C${m.macros.C} · F${m.macros.F}</div>
          </div>
          <div class="card-body">
            <ul class="list-disc pl-5 space-y-1 text-sm">
              ${m.items.map(it => `<li>${esc(it)}</li>`).join("")}
            </ul>
          </div>
          <div class="card-footer flex gap-2">
            <button class="btn btn-secondary"><i data-lucide="shuffle" class="h-4 w-4"></i>Swap</button>
            <button class="btn btn-primary"><i data-lucide="plus" class="h-4 w-4"></i>Log</button>
          </div>
        `;
        grid.appendChild(el);
      });
      lucide.createIcons();
    }

    function renderChat() {
      const sc = $("chatScroll");
      sc.innerHTML = "";
      messages.forEach(m => {
        const wrap = document.createElement("div");
        wrap.className = (m.role === "user")
          ? "ml-auto bubble-user"
          : "mr-auto bubble-ai";
        wrap.innerHTML = `
          <div class="text-[11px] mb-1" style="color: var(--muted)">${m.role}</div>
          <div class="text-sm leading-relaxed whitespace-pre-wrap">${esc(m.content)}</div>
        `;
        sc.appendChild(wrap);
      });
      sc.scrollTop = sc.scrollHeight;
    }

    function renderKcals() {
      $("pOut").textContent = macroBias.protein;
      $("fOut").textContent = macroBias.fat;
      $("cOut").textContent = macroBias.carbs;
      $("kcalOut").textContent = kcalFromMacros(macroBias);
    }

    // ---------- CHARTS ----------
    let weightChart, calChart;
    function chartColors() {
      const styles = getComputedStyle(document.documentElement);
      return {
        line: styles.getPropertyValue("--accent").trim() || "#22c55e",
        bar:  styles.getPropertyValue("--accent-2").trim() || "#10b981",
        grid: styles.getPropertyValue("--border").trim() || "#24262b",
        text: styles.getPropertyValue("--muted").trim() || "#a1a1ac"
      };
    }
    function initCharts() {
      const demo = [
        { day:"Mon", weight:175.0, calories:2400 },
        { day:"Tue", weight:174.8, calories:2380 },
        { day:"Wed", weight:174.5, calories:2450 },
        { day:"Thu", weight:174.3, calories:2300 },
        { day:"Fri", weight:174.2, calories:2360 },
        { day:"Sat", weight:174.1, calories:2500 },
        { day:"Sun", weight:174.0, calories:2350 },
      ];
      const { line, bar, grid, text } = chartColors();

      const wctx = $("weightChart").getContext("2d");
      weightChart = new Chart(wctx, {
        type: "line",
        data: {
          labels: demo.map(d=>d.day),
          datasets: [{ data: demo.map(d=>d.weight), borderColor: line, borderWidth: 2, tension: .35, pointRadius: 0 }]
        },
        options: {
          plugins: { legend:{ display:false } },
          scales: {
            x: { grid:{ color: grid }, ticks:{ color: text } },
            y: { grid:{ color: grid }, ticks:{ color: text, maxTicksLimit:5 }, suggestedMin:173.5, suggestedMax:175.5 }
          }
        }
      });

      const cctx = $("calChart").getContext("2d");
      calChart = new Chart(cctx, {
        type: "bar",
        data: { labels: demo.map(d=>d.day), datasets: [{ data: demo.map(d=>d.calories), backgroundColor: bar }] },
        options: {
          plugins: { legend:{ display:false } },
          scales: {
            x: { grid:{ color: grid }, ticks:{ color: text } },
            y: { grid:{ color: grid }, ticks:{ color: text, maxTicksLimit:5 } }
          }
        }
      });
    }
    function rebuildCharts() {
      if (weightChart) { weightChart.destroy(); }
      if (calChart) { calChart.destroy(); }
      initCharts();
    }

    // ---------- API WRAPPERS ----------
    async function askAssistant(text) {
      try {
        const res = await apiFetch("/chat", { message:text, context: macroBias });
        return res.reply || "(no reply)";
      } catch (e) {
        console.error(e);
        return "Error contacting server.";
      }
    }
    async function generatePlan() {
      setLoading(true);
      try {
        const res = await apiFetch("/plan", {
          protein: macroBias.protein, fat: macroBias.fat, carbs: macroBias.carbs,
          prefs: $("prefsText").value || ""
        });
        meals = Array.isArray(res.meals) && res.meals.length
          ? res.meals
          : Array.from({ length: 6 }, (_, i) => ({
              ...starterMeals[i % 3],
              id: i + 1, title: starterMeals[i % 3].title + " #" + (i + 1)
            }));
        renderMeals();
      } catch (e) {
        console.error(e);
        alert("Plan generation failed.");
      } finally { setLoading(false); }
    }
    async function analyzeMeal() {
      setLoading(true);
      try {
        const rec = $("recipeInput").value || "7oz sirloin, 200g cooked rice, 1 tbsp olive oil, broccoli";
        const res = await apiFetch("/analyze_meal", { text: rec, macros: macroBias });
        messages.push({ role:"assistant", content: res.advice || "No advice returned." });
        renderChat();
      } catch (e) {
        console.error(e);
        messages.push({ role:"assistant", content: "Meal analysis failed." });
        renderChat();
      } finally { setLoading(false); }
    }

    // ---------- EVENTS ----------
    function wireEvents() {
      // Macros
      $("pRange").addEventListener("input", e => { macroBias.protein = +e.target.value; renderKcals(); });
      $("fRange").addEventListener("input", e => { macroBias.fat = +e.target.value; renderKcals(); });
      $("cRange").addEventListener("input", e => { macroBias.carbs = +e.target.value; renderKcals(); });

      // Preferences dialog
      const dlg = $("prefsDialog");
      $("btnPrefs").addEventListener("click", () => dlg.showModal());
      $("prefsClose").addEventListener("click", () => dlg.close());
      $("prefsSave").addEventListener("click", () => dlg.close());

      // Actions
      $("btnGeneratePlan").addEventListener("click", generatePlan);
      $("qaGenerate").addEventListener("click", generatePlan);
      $("btnAnalyzeMeal").addEventListener("click", analyzeMeal);
      $("qaAnalyze").addEventListener("click", analyzeMeal);
      $("qaBuildWeek").addEventListener("click", generatePlan);

      // Chat
      const chatInput = $("chatInput");
      $("btnSend").addEventListener("click", async () => {
        const text = chatInput.value.trim();
        if (!text) return;
        messages.push({ role:"user", content:text });
        renderChat();
        chatInput.value = "";
        setLoading(true);
        const reply = await askAssistant(text);
        messages.push({ role:"assistant", content: reply });
        renderChat();
        setLoading(false);
      });
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); $("btnSend").click(); }
      });
    }

    // ---------- INIT ----------
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await ensureLogin();
      } catch { return; }
      $("year").textContent = new Date().getFullYear();
      lucide.createIcons();
      renderKcals();
      renderMeals();
      renderChat();
      initCharts();
      wireEvents();
    });
  </script>
</body>
</html>
